# Basic-app example

This example shows how to use **Softprobe** for record & replay: add `softprobe/init` to your app, capture traffic via HTTP headers, and replay it with the `softprobe diff` CLI.

**Configuration:** Mode and cassette directory come from **YAML config only**. Do not use `SOFTPROBE_MODE`, `SOFTPROBE_CASSETTE_PATH`, or `SOFTPROBE_CASSETTE_DIRECTORY`. The app reads `./.softprobe/config.yml` by default, or the path in `SOFTPROBE_CONFIG_PATH`.

---

## Primary path: one-shot test

From the **repository root**:

```bash
npm run example:test    # starts Postgres + Redis, capture → replay (no deps) → diff; exit code = test result
```

The script (`test-with-capture-replay.sh`) starts the stack, runs the app with capture YAML, sends one request with capture headers and flushes, stops the stack, starts the app with replay-capable YAML, and runs `softprobe diff`. Cassette output is generated by the capture step and is not checked in.

To stop services afterward: `npm run example:down`.

---

## Optional: Business regression demo

To see **regression detection in app logic** (not tracing/header variance):

1. **Capture baseline** — Run `npm run example:test` once (or capture with headers + flush). The response includes `businessRegressionDemo: "baseline"`.
2. **Enable the demo bug** — Start the app with `SOFTPROBE_DEMO_BUG=1` and replay-capable YAML. The app returns `businessRegressionDemo: "buggy"`.
3. **Run diff** — Run `softprobe diff` against that server. Diff fails because the response body changed.

---

## How it works

1. **Softprobe runs first** — Your app loads `softprobe/init` before OpenTelemetry (see `instrumentation.ts`). Init reads the YAML config (mode, cassetteDirectory). That enables capture/replay and patches Express so the Softprobe middleware is applied automatically.

2. **Capture** — A request with **capture headers** (`x-softprobe-mode: CAPTURE`, `x-softprobe-trace-id: <id>`) is recorded into NDJSON (inbound + outbound Postgres, Redis, HTTP). The server writes to `{cassetteDirectory}/{traceId}.ndjson`. Call `/flush` so the cassette is written to disk.

3. **Replay and diff** — `softprobe diff <cassette> <url>` sends the request with **replay headers** (`x-softprobe-mode: REPLAY`, `x-softprobe-trace-id`). The server handles that request in REPLAY (mocked fetch/Postgres/Redis from the cassette). The CLI exits 0 if the response matches the recording. The server must have `cassetteDirectory` set (from YAML) and be in a mode that supports replay (PASSTHROUGH or REPLAY from config).

---

## What’s in this example

| File | Purpose |
|------|---------|
| `test-with-capture-replay.sh` | **Canonical** one-shot: capture → replay server → `softprobe diff` (used by `npm run example:test`). |
| `replay-and-diff.sh` | Run diff against an existing cassette (used by `npm run example:replay-then-diff`). Create cassette first (e.g. via `example:test` or manual capture). |
| `.softprobe/config.yml` | Example YAML: `mode: CAPTURE`, `cassetteDirectory: "."`. |
| `.softprobe/config-passthrough.yml` | Example YAML: `mode: PASSTHROUGH`, same cassetteDirectory — for one server doing both capture and replay via headers. |
| `instrumentation.ts` | Load `softprobe/init` first, then OpenTelemetry. Used via `-r ./instrumentation.ts`. |
| `run.ts` | Demo app: Express with Postgres, Redis, and outbound HTTP. Uses `require('express')` so Softprobe middleware is injected. |
| `capture-runner.ts` | *Internal*: used by `npm run example:capture` (non-canonical; prefer `example:test` for full flow). |
| `replay-runner.ts` | *Internal*: used by `npm run example:replay` (non-canonical; for diff use `example:replay-then-diff` or `example:test`). |

All commands are run from the **repository root** unless noted.

### If the diff tool fails

- **Run diff from the repository root** — The CLI resolves the cassette path with `path.resolve(process.cwd(), file)`. From repo root: `bin/softprobe diff examples/basic-app/<traceId>.ndjson http://localhost:3010`.
- **Upstream header variance** — The example calls httpbin.org; responses include headers (Traceparent, User-Agent, X-Amzn-Trace-Id) that vary. The canonical script uses `--ignore-paths http.headers` so the test passes. For manual diff you can do: `bin/softprobe diff --ignore-paths http.headers examples/basic-app/<traceId>.ndjson http://localhost:3010`.

---

## Manual run (explore the app)

**Prerequisites:** Node.js, Docker. From repo root: `npm install`, `npm run example:up`.

**Run the app:** `npm run example:run`. Then open `http://localhost:3000/` for JSON (postgres, redis, http).

**Capture manually:** With the server running (YAML with cassetteDirectory), send a request with `x-softprobe-mode: CAPTURE` and `x-softprobe-trace-id: <id>`, then `GET /flush`. File is written to `{cassetteDirectory}/{id}.ndjson`.

**Replay/diff:** Start the server with replay-capable YAML (e.g. `SOFTPROBE_CONFIG_PATH=./.softprobe/config-passthrough.yml`), then from repo root: `bin/softprobe diff examples/basic-app/<id>.ndjson http://localhost:3000`.

**Stop:** `npm run example:kill` (ports 3000, 3010), `npm run example:down` (Docker). `npm run example:kill-e2e` if E2E worker processes are left over.

---

## Summary

| Goal | What to do |
|------|------------|
| Run the example | `npm run example:test` (primary path). |
| Add Softprobe to your app | Import `softprobe/init` first (e.g. in `instrumentation.ts`), then load OTel. Use `require('express')` so middleware is injected. |
| Configure | YAML (default `./.softprobe/config.yml` or `SOFTPROBE_CONFIG_PATH`). Set `mode` and `cassetteDirectory`. |
| Record a request | Send `x-softprobe-mode: CAPTURE` and `x-softprobe-trace-id: <id>`, then `/flush`. |
| Replay and compare | Server with replay-capable YAML; run `softprobe diff <cassette.ndjson> <url>` from repo root. |

See the main [Softprobe README](../../README.md), [design.md](../../design.md), [design-context.md](../../design-context.md), [design-cassette.md](../../design-cassette.md), and [design-matcher.md](../../design-matcher.md) for more.
